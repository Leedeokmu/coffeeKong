<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coffeekong.mapper.OrderMapper">

	<resultMap id="Order" type="com.coffeekong.domain.OrderVO" >
		<id property="oId" column="o_id"/>
		<result property="email" column="u_email"/>
		<result property="price" column="o_price"/>
		<result property="fname" column="o_rfname"/>
		<result property="lname" column="o_rlname"/>
		<result property="phone" column="o_phone"/>
		<result property="postcode" column="o_postcode"/>
		<result property="addr" column="o_addr"/>
		<result property="state" column="o_state"/>
		<result property="date" column="o_date"/>
		<collection property="opvo" resultMap="OrderProd" ofType="com.coffeekong.domain.OrderProdVO"/>
	</resultMap>

	<resultMap id="OrderProd" type="com.coffeekong.domain.OrderProdVO">
		<result property="orderId" column="o_id"/>
		<result property="productId" column="p_id"/>
		<result property="name" column="p_name"/>
		<result property="category" column="p_category"/>
		<result property="img" column="p_img"/>
		<result property="qty" column="op_qty"/>
		<result property="sz" column="op_sz"/>
		<result property="type" column="op_type"/>
		<result property="price" column="op_price"/>
	</resultMap>

	<sql id="searchByEmail">
		<if test="cri.searchType != null">
			<if test="cri.searchType == 'prodNm'.toString()">
				AND
					LOWER(p.p_name)
				LIKE
				  	CONCAT('%',#{cri.keyword},'%')
			</if>
		</if>
	</sql>
	
	<sql id="search">
		<if test="searchType != null">
			<if test="searchType == 'prodNm'.toString()">
				WHERE
					LOWER(p.p_name)
				LIKE
					CONCAT('%',#{keyword},'%')
			</if>
			<if test="searchType == 'email'.toString()">
				WHERE
					LOWER(o.u_email)
				LIKE
					CONCAT('%',#{keyword},'%')
			</if>
		</if>
	</sql>

	<select id="listByEmail" resultMap="Order">
		SELECT
			o.o_id, p.p_name,p.p_category,p.p_img, op.p_id,op.op_qty,op.op_sz,op.op_type,op.op_price,
			o.o_price,o.o_rfname,o.o_rlname,o.o_phone,o.o_postcode,o.o_addr,o.o_state,o.o_date
		FROM
			tbl_order o
		LEFT JOIN
			tbl_order_prod op
		ON
			o.o_id = op.o_id
		INNER JOIN
			tbl_prod p
		ON
			op.p_id=p.p_id
		WHERE
			o.u_email = #{email}
			<include refid="searchByEmail"></include>
		ORDER BY
			o.o_id
		LIMIT
			(#{cri.page} - 1) * #{cri.perPageNum}, #{cri.perPageNum}
	</select>
	<select id="listCountByEmail">
		SELECT
			count(*)
		FROM
			tbl_order o
		INNER JOIN
			tbl_order_prod op
		ON
			o.o_id=op.o_id
		INNER JOIN
			tbl_prod p
		ON
			op.p_id=p.p_id
		WHERE o.u_email=#{email}
		<include refid="searchByEmail"></include>
	</select>
	<select id="list" parameterType="com.coffeekong.domain.SearchCriteria" resultMap="Order">
		SELECT
			o.o_id, o.u_email,p.p_name,p.p_category,p.p_img, op.p_id,op.op_qty,op.op_sz,op.op_type,op.op_price,
			o.o_price,o.o_rfname,o.o_rlname,o.o_phone,o.o_postcode,o.o_addr,o.o_state,o.o_date
		FROM
			tbl_order o
		LEFT JOIN
			tbl_order_prod op
		ON
			o.o_id = op.o_id
		INNER JOIN
			tbl_prod p
		ON
			op.p_id=p.p_id
		<include refid="search"></include>
		ORDER BY
			o.o_id
		LIMIT
			(#{page} -1) * #{perPageNum}, #{perPageNum}
	</select>
	<select id="listCount" parameterType="com.coffeekong.domain.SearchCriteria" resultType="int">
		SELECT count(*)
		FROM tbl_order o INNER JOIN 
			(
				tbl_order_prod op INNER JOIN tbl_prod p
				ON op.p_id=p.p_id
			)
		ON o.o_id=op.o_id
		<include refid="search"></include>
	</select>
	<select id="getByOid" resultMap="Order">
		SELECT 
			o.o_id, o.u_email,p.p_name,p.p_category,p.p_img, op.p_id,op.op_qty,op.op_sz,op.op_type,op.op_price, 
			o.o_price,o.o_rfname,o.o_rlname,o.o_phone,o.o_postcode,o.o_addr,o.o_state,o.o_date
		FROM 
			tbl_order o
		LEFT JOIN
			tbl_order_prod op
		ON
			o.o_id = op.o_id
		INNER JOIN
			tbl_prod p
		ON
			op.p_id=p.p_id
		WHERE
			o.o_id = #{oid}
	</select>
	
	<insert id="insOrd" parameterType="com.coffeekong.domain.OrderVO">
		INSERT INTO
			tbl_order(u_email, o_price, o_rfname, o_rlname, o_phone, o_postcode, o_addr, o_state, o_date)
		VALUES(
			#{u_email}, #{o_price}, #{o_rfname},
			#{o_rlname}, #{o_phone}, #{o_postcode}, #{o_addr},
			'waiting payment', sysdate
		)
	</insert>
	<insert id="insOrdProd" parameterType="com.coffeekong.domain.CartVO">
		INSERT INTO
			tbl_order_prod(o_id, p_id, op_qty, op_sz, op_type, op_price)
		VALUES(
			#{o_id}, #{p_id},#{qty}, #{sz}, #{type}, #{sub_price}
		)
	</insert>
	<insert id="insOrdProdTool" parameterType="com.coffeekong.domain.CartVO">
		INSERT INTO
			tbl_order_prod(o_id, p_id, op_qty, op_price)
		VALUES(
			#{o_id}, #{vo.p_id}, #{vo.qty}, #{vo.sub_price}
		)
	</insert>
	
	<update id="update" parameterType="com.coffeekong.domain.OrderVO">
		UPDATE 
			tbl_order
		SET
			o_price=#{o_price},o_rfname=#{o_rfname}, o_rlname=#{o_rlname}, o_phone=#{o_phone}, o_postcode=#{o_postcode}, o_addr=#{o_addr}
		WHERE
			o_id=#{o_id}
	</update>
	<delete id="deleteOrd" >
		DELETE FROM
			tbl_order
		WHERE
			o_id=#{oid}
	</delete>
	<delete id="deleteOrdProd" >
		DELETE FROM
			tbl_order_prod
		WHERE
			o_id=#{oid}
	</delete>
	<update id="updateState" >
		UPDATE
			tbl_order
		SET
			o_state=#{state}
		WHERE
			o_id=#{oid}
	</update>
	
</mapper>